<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å©šç¦®ç¥æ”æ‰‹ V25.1 - æ´»å‹•åŸ·è¡Œæˆ°æƒ…å®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .hidden-scrollbar::-webkit-scrollbar { display: none; }
        .hidden-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .confetti { position: absolute; width: 12px; height: 12px; background-color: #f00; animation: fall linear forwards; z-index: 50; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
        .lightbox-backdrop { background-color: rgba(0, 0, 0, 0.95); }
        .lightbox-img { max-height: 70vh; max-width: 90vw; object-fit: contain; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
        .screen-img { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
        .blur-state { filter: blur(20px) brightness(0.5); transform: scale(1.05); transition: all 1s ease; }
        .clear-state { filter: blur(0) brightness(1); transform: scale(1); transition: all 1s ease; }
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-active { transform: translateY(0); opacity: 1; transition: all 0.5s ease; }
        .toast-exit { transform: translateY(100%); opacity: 0; transition: all 0.5s ease; }
        .new-tag { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .cat-btn.active { border-left-color: #1e293b !important; font-weight: 700 !important; color: #1e293b !important; }
        .cat-btn:not(.active) { border-left-color: transparent !important; color: #64748b !important; }
        .screen-mode-btn.active { transform: scale(1.02); }
        .screen-controls-hidden .screen-controller, .screen-controls-hidden .screen-header { opacity: 0 !important; pointer-events: none !important; }
        .screen-controller, .screen-header { transition: opacity 0.3s ease; }
        .photo-preview { aspect-ratio: 4/3; background: #1e293b; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .photo-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col overflow-hidden text-slate-800">

<!-- Lightbox -->
<div class="fixed inset-0 z-[100] lightbox-backdrop hidden flex flex-col items-center justify-center opacity-0 transition-opacity duration-300" id="lightbox" onclick="closeLightbox(event)">
    <div class="absolute top-8 left-1/2 -translate-x-1/2 z-20 text-center pointer-events-none">
        <div class="bg-black/70 backdrop-blur-xl rounded-2xl px-8 py-4 border border-white/20 shadow-2xl">
            <span class="inline-block px-4 py-1.5 rounded-full text-base font-bold text-white mb-2 shadow-lg" id="lb-cat-badge">Category</span>
            <div class="font-black text-3xl text-white tracking-wide drop-shadow-lg" id="lb-user-display">User Name</div>
        </div>
    </div>
    <button class="absolute top-4 right-4 text-white/70 hover:text-white p-3 rounded-full hover:bg-white/10 transition z-30" onclick="closeLightbox(null, true)"><span class="material-symbols-outlined text-3xl">close</span></button>
    <div class="relative flex-1 w-full h-full flex items-center justify-center p-4 pt-28" onclick="event.stopPropagation()">
        <button class="absolute left-4 md:left-8 p-4 text-white/50 hover:text-white hover:bg-black/30 rounded-full transition z-20" onclick="lbNav(-1)"><span class="material-symbols-outlined text-4xl">chevron_left</span></button>
        <button class="absolute right-4 md:right-8 p-4 text-white/50 hover:text-white hover:bg-black/30 rounded-full transition z-20" onclick="lbNav(1)"><span class="material-symbols-outlined text-4xl">chevron_right</span></button>
        <img class="lightbox-img rounded-lg" id="lb-img" src="">
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300 z-30" id="lb-feedback"><div class="bg-black/60 p-8 rounded-full backdrop-blur-md shadow-2xl"><span class="material-symbols-outlined text-8xl text-white" id="lb-feedback-icon">check</span></div></div>
    </div>
    <div class="absolute bottom-8 bg-black/40 backdrop-blur-md border border-white/10 rounded-full px-8 py-4 flex gap-4 pointer-events-auto shadow-2xl z-[110]" id="lb-actions"></div>
</div>

<!-- Intro Modal -->
<div class="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-4" id="intro-modal">
    <div class="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl relative overflow-hidden flex flex-col slide-up">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-500 to-purple-600"></div>
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-slate-900"><span class="material-symbols-outlined text-pink-600">admin_panel_settings</span> æ´»å‹•åŸ·è¡Œæˆ°æƒ…å®¤ V25.1</h2>
        <p class="text-slate-600 mb-4 text-sm">å³å°‡é€£ç·šè‡³ Render å¾Œç«¯ï¼š<br><span class="font-mono bg-slate-100 px-2 py-1 rounded text-xs text-slate-500 mt-1 block truncate">https://fongde-wedding-backend.onrender.com</span></p>
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4 text-xs text-amber-800"><strong>âš ï¸ æ³¨æ„ï¼š</strong> é¦–æ¬¡é€£ç·šå¯èƒ½éœ€è¦ 30-60 ç§’å–šé†’ã€‚</div>
        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-6 text-xs text-green-800"><strong>âœ… V25.1 æ–°åŠŸèƒ½ï¼š</strong><br>â€¢ æœ¬åœ°å¿«å–ä¿è­·ï¼ˆå¾Œç«¯é‡å•Ÿä¸æœƒéºå¤±ï¼‰<br>â€¢ 2ç§’åŒæ­¥é€Ÿåº¦<br>â€¢ ç§»é™¤äºŒæ¬¡å£“ç¸®ï¼Œæ›´ç©©å®š</div>
        <button class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition flex justify-center items-center gap-2 shadow-lg" onclick="startApp()">å•Ÿå‹•é€£ç·š <span class="material-symbols-outlined">power_settings_new</span></button>
    </div>
</div>

<!-- Confirm Modal -->
<div class="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 hidden backdrop-blur-md" id="confirm-modal">
    <div class="bg-white rounded-2xl max-w-5xl w-full p-8 shadow-2xl relative border border-slate-200">
        <div class="text-center mb-8"><h2 class="text-3xl font-black text-slate-900 mb-2">ğŸ† æœ€çµ‚å¾—çåå–®ç¢ºèª</h2><p class="text-slate-500">é–å®šå¾Œå°‡ç„¡æ³•ä¿®æ”¹ï¼Œä¸¦é–‹å•Ÿã€Œé ’çç’°ç¯€ã€ã€‚</p></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="flex flex-col items-center" id="confirm-card-groom"></div><div class="flex flex-col items-center" id="confirm-card-bride"></div><div class="flex flex-col items-center" id="confirm-card-creative"></div></div>
        <div class="flex gap-4 justify-center"><button class="px-6 py-2 rounded-lg border-2 border-slate-300 font-bold text-slate-500 hover:bg-slate-100" onclick="closeConfirmModal()">è¿”å›ä¿®æ”¹</button><button class="px-8 py-2 rounded-lg bg-pink-600 text-white font-bold shadow-lg hover:bg-pink-700 hover:scale-105 transition" onclick="finalizeWinners()">ç¢ºèªé–å®š</button></div>
    </div>
</div>

<!-- Settings Modal -->
<div class="fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4 hidden" id="settings-modal">
    <div class="bg-white rounded-2xl max-w-2xl w-full p-8 shadow-2xl flex flex-col relative slide-up max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6 border-b pb-4"><h2 class="text-xl font-bold text-slate-900 flex items-center gap-2"><span class="material-symbols-outlined text-slate-600">settings</span> ç³»çµ±è¨­å®š</h2><button onclick="document.getElementById('settings-modal').classList.add('hidden')"><span class="material-symbols-outlined text-2xl text-slate-400 hover:text-slate-800">close</span></button></div>
        <div class="mb-6 p-4 rounded-xl border-2 border-dashed border-amber-300 bg-amber-50"><div class="flex justify-between items-center mb-3"><div><h3 class="font-bold text-lg text-amber-800 flex items-center gap-2"><span class="material-symbols-outlined">science</span> æ¸¬è©¦æ¨¡å¼</h3><p class="text-sm text-amber-700">æ‰¹é‡ä¸Šå‚³ã€è‡ªå‹•ç·¨è™Ÿã€Œè³“å®¢1ã€ã€Œè³“å®¢2ã€...</p></div><span class="text-xs font-bold px-2 py-1 rounded" id="test-mode-badge">æª¢æŸ¥ä¸­...</span></div><button class="w-full py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition" id="btn-toggle-test-mode" onclick="toggleTestMode()"><span class="material-symbols-outlined" id="test-mode-icon">toggle_off</span><span id="test-mode-btn-text">è¼‰å…¥ä¸­...</span></button></div>
        <div class="mb-6 p-4 rounded-xl border border-slate-200 bg-slate-50"><div class="flex justify-between items-center mb-3"><div><h3 class="font-bold text-lg text-slate-800 flex items-center gap-2"><span class="material-symbols-outlined">how_to_reg</span> å ±åç‹€æ…‹</h3><p class="text-sm text-slate-500">æ§åˆ¶ LINE å®˜æ–¹å¸³è™Ÿæ˜¯å¦æ¥å—æ–°ç…§ç‰‡</p></div><span class="text-xs font-bold px-2 py-1 rounded" id="submission-status-badge">æª¢æŸ¥ä¸­...</span></div><button class="w-full py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition" id="btn-toggle-submission" onclick="toggleSubmissionAPI()"><span class="material-symbols-outlined" id="submission-icon">toggle_on</span><span id="submission-btn-text">è¼‰å…¥ä¸­...</span></button></div>
        <div class="mb-6 p-4 rounded-xl border border-blue-200 bg-blue-50"><div class="flex justify-between items-center mb-3"><div><h3 class="font-bold text-lg text-blue-800 flex items-center gap-2"><span class="material-symbols-outlined">cloud_download</span> è‡ªå‹•å‚™ä»½</h3><p class="text-sm text-blue-600">æ¯ 90 ç§’è‡ªå‹•ä¸‹è¼‰æ–°ç…§ç‰‡</p></div><span class="text-xs font-bold px-2 py-1 rounded" id="backup-status-badge">æœªå•Ÿç”¨</span></div><div class="space-y-3"><div class="flex gap-2"><button class="flex-1 py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition bg-blue-600 hover:bg-blue-700 text-white" onclick="selectBackupFolder()"><span class="material-symbols-outlined">folder_open</span><span id="backup-folder-text">é¸æ“‡è³‡æ–™å¤¾</span></button><button class="py-3 px-4 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition bg-slate-200 hover:bg-slate-300 text-slate-700" id="btn-toggle-backup" onclick="toggleAutoBackup()" disabled><span class="material-symbols-outlined" id="backup-toggle-icon">play_arrow</span></button></div><div class="text-xs text-blue-700 bg-blue-100 rounded-lg p-2"><div class="flex justify-between"><span>å·²å‚™ä»½:</span> <span id="backup-count">0 å¼µ</span></div><div class="flex justify-between"><span>å…¥åœå‚™ä»½:</span> <span id="backup-approved-count">0 å¼µ</span></div></div></div></div>
        <div class="mb-6 p-4 rounded-xl border border-slate-200"><h3 class="font-bold text-lg text-slate-800 mb-3 flex items-center gap-2"><span class="material-symbols-outlined">download</span> æ‰‹å‹•ä¸‹è¼‰</h3><div class="grid grid-cols-2 gap-3"><button class="py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition bg-slate-700 hover:bg-slate-800 text-white" onclick="downloadAllPhotos()"><span class="material-symbols-outlined">photo_library</span> å…¨éƒ¨ç…§ç‰‡</button><button class="py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition bg-pink-600 hover:bg-pink-700 text-white" onclick="downloadApprovedPhotos()"><span class="material-symbols-outlined">stars</span> å…¥åœç…§ç‰‡</button></div></div>
        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 text-xs text-slate-500 flex flex-col gap-2"><div class="flex justify-between"><span>å¾Œç«¯ç…§ç‰‡:</span> <span class="font-mono text-green-600" id="debug-photos">0 å¼µ</span></div><div class="flex justify-between"><span>æœ¬åœ°å¿«å–:</span> <span class="font-mono text-blue-600" id="debug-local">0 å¼µ</span></div><div class="flex justify-between"><span>è¨˜æ†¶é«”:</span> <span class="font-mono text-blue-600" id="debug-mem">--</span></div></div>
    </div>
</div>

<!-- Header -->
<nav class="bg-white border-b h-16 flex items-center justify-between px-6 flex-shrink-0 z-20 shadow-sm relative w-full" id="main-header">
    <div class="flex items-center gap-4">
        <div class="bg-gradient-to-tr from-pink-600 to-purple-600 text-white p-2 rounded-lg shadow-md"><span class="material-symbols-outlined block">photo_camera</span></div>
        <div>
            <h1 class="font-bold text-lg text-slate-800 tracking-wide">å©šç¦®ç¥æ”æ‰‹ <span class="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full ml-1 border">V25.1</span></h1>
            <div class="text-xs text-slate-500 flex items-center gap-1">
                <span class="w-2 h-2 bg-slate-400 rounded-full" id="status-dot"></span> 
                ç‹€æ…‹: <span class="font-bold text-slate-500" id="sys-status">ç­‰å¾…é€£ç·š</span>
                <button class="ml-2 px-2 py-0.5 bg-blue-500 text-white text-[10px] rounded font-bold hover:bg-blue-600 hidden" id="btn-reconnect" onclick="manualReconnect()">é‡æ–°é€£ç·š</button>
            </div>
        </div>
    </div>
    <div class="flex bg-slate-100 p-1 rounded-xl shadow-inner"><button class="px-5 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 bg-white shadow-sm text-slate-800 ring-1 ring-slate-200" id="tab-helper" onclick="switchTab('helper')"><span class="material-symbols-outlined text-lg">filter_alt</span> å°å¹«æ‰‹</button><button class="px-5 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 text-slate-500 hover:text-slate-900" id="tab-couple" onclick="switchTab('couple')"><span class="material-symbols-outlined text-lg">how_to_reg</span> æ–°äºº</button><button class="px-5 py-2 rounded-lg text-sm font-bold transition text-slate-500 hover:text-slate-900 flex items-center gap-2" id="tab-screen" onclick="switchTab('screen')"><span class="material-symbols-outlined text-lg">connected_tv</span> æŠ•å½±</button></div>
    <button class="p-2 text-slate-400 hover:text-slate-700 transition" onclick="document.getElementById('settings-modal').classList.remove('hidden')"><span class="material-symbols-outlined">settings</span></button>
</nav>

<!-- Main Content -->
<div class="flex flex-1 overflow-hidden w-full h-full" id="main-content">
    <main class="flex-1 bg-slate-50 relative overflow-hidden flex flex-col w-full h-full">
        
        <!-- VIEW 1: HELPER -->
        <div class="view-section h-full flex flex-col p-6 min-h-0 w-full" id="view-helper">
            <div class="flex justify-between items-start mb-4 flex-shrink-0 bg-white p-4 rounded-xl border border-slate-200 shadow-sm w-full">
                <div><div class="flex items-center gap-3 mb-1"><h2 class="text-2xl font-bold text-slate-800">åˆé¸å¯©æ ¸</h2><div class="flex bg-slate-100 rounded-lg p-1 gap-1"><button class="px-3 py-1 text-xs font-bold rounded shadow bg-white text-slate-800" id="btn-helper-pending" onclick="setHelperMode('pending')">å¾…å¯©æ ¸</button><button class="px-3 py-1 text-xs font-bold rounded text-slate-500 hover:bg-white flex items-center gap-1" id="btn-helper-trash" onclick="setHelperMode('trash')"><span class="material-symbols-outlined text-[14px]">delete</span> å·²åˆªé™¤</button></div></div><p class="text-slate-500 text-sm" id="helper-msg">å°šæœªé€£ç·šï¼Œè«‹å…ˆå•Ÿå‹•ç³»çµ±ã€‚</p></div>
                <div class="flex items-center gap-4"><div class="flex flex-col items-end mr-4"><div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">å…¥åœæ•¸é‡</div><div class="flex gap-2"><div class="px-3 py-1 rounded bg-blue-50 text-blue-700 text-xs font-bold border border-blue-100" id="prog-groom">ğŸ¤µ 0</div><div class="px-3 py-1 rounded bg-pink-50 text-pink-700 text-xs font-bold border border-pink-100" id="prog-bride">ğŸ‘° 0</div><div class="px-3 py-1 rounded bg-amber-50 text-amber-700 text-xs font-bold border border-amber-100" id="prog-creative">ğŸ’¡ 0</div></div></div><div class="h-10 w-px bg-slate-200"></div><button class="flex flex-col items-center text-slate-500 hover:text-red-600 transition group" onclick="resetSystem()"><div class="w-10 h-10 rounded-full bg-slate-100 group-hover:bg-red-50 flex items-center justify-center mb-1"><span class="material-symbols-outlined">restart_alt</span></div><span class="text-[10px] font-bold">å…¨éƒ¨é‡ç½®</span></button></div>
            </div>
            <div class="flex-1 overflow-y-auto min-h-0 bg-white border rounded-2xl p-4 shadow-inner relative w-full"><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 pb-24" id="helper-grid-content"></div><div class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 pointer-events-none" id="helper-empty"><span class="material-symbols-outlined text-6xl mb-2 opacity-30">inbox</span><p class="font-medium">ç›®å‰æ²’æœ‰æ–°ç…§ç‰‡</p></div></div>
        </div>

        <!-- VIEW 2: COUPLE -->
        <div class="view-section h-full flex-col p-6 min-h-0 w-full hidden" id="view-couple">
            <div class="flex justify-between items-center mb-6 flex-shrink-0"><div><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2"><span class="material-symbols-outlined text-pink-500">loyalty</span> æ–°äººæ±ºé¸</h2><p class="text-slate-500 text-sm">æ¯é¡åˆ¥é¸ 1 åå† è»ã€‚é–å®šå¾Œé–‹å•Ÿã€Œé ’çç’°ç¯€ã€ã€‚</p></div><button class="bg-slate-200 text-slate-400 px-6 py-3 rounded-xl font-bold flex items-center gap-2 cursor-not-allowed" disabled id="btn-lock-winners" onclick="openConfirmModal()"><span class="material-symbols-outlined">lock</span> å°šæœªé¸æ»¿</button></div>
            <div class="flex gap-6 h-full overflow-hidden min-h-0">
                <div class="w-56 flex flex-col gap-3 flex-shrink-0"><button class="cat-btn active text-left px-4 py-3 rounded-xl bg-white border shadow-sm border-l-4 font-bold" data-cat="all" onclick="filterCouple('all')">å…¨éƒ¨å…¥åœ</button><button class="cat-btn text-left px-4 py-3 rounded-xl bg-white border shadow-sm border-l-4" data-cat="groom" onclick="filterCouple('groom')">æœ€å¸¥æ–°éƒè³</button><button class="cat-btn text-left px-4 py-3 rounded-xl bg-white border shadow-sm border-l-4" data-cat="bride" onclick="filterCouple('bride')">æœ€ç¾æ–°å¨˜è³</button><button class="cat-btn text-left px-4 py-3 rounded-xl bg-white border shadow-sm border-l-4" data-cat="creative" onclick="filterCouple('creative')">æœ€ä½³å‰µæ„è³</button><div class="mt-auto bg-white p-4 rounded-xl border shadow-sm"><div class="text-xs font-bold text-slate-400 uppercase mb-2 flex items-center gap-1"><span class="material-symbols-outlined text-sm">trophy</span> å¾—çåå–®</div><div class="space-y-2 text-sm"><div class="flex justify-between items-center p-2 rounded bg-slate-50" id="stat-winner-groom"><span>æœ€å¸¥æ–°éƒè³</span> <span class="text-slate-300">--</span></div><div class="flex justify-between items-center p-2 rounded bg-slate-50" id="stat-winner-bride"><span>æœ€ç¾æ–°å¨˜è³</span> <span class="text-slate-300">--</span></div><div class="flex justify-between items-center p-2 rounded bg-slate-50" id="stat-winner-creative"><span>æœ€ä½³å‰µæ„è³</span> <span class="text-slate-300">--</span></div></div></div></div>
                <div class="flex-1 overflow-y-auto min-h-0 bg-white border rounded-2xl p-4 shadow-inner"><div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 pb-20" id="couple-grid-content"></div></div>
            </div>
        </div>

        <!-- VIEW 3: SCREEN -->
        <div class="view-section h-full bg-black hidden relative select-none overflow-hidden w-full" id="view-screen">
            <div class="screen-header absolute top-0 left-0 right-0 h-14 bg-gradient-to-b from-black/80 to-transparent z-40 flex items-center justify-between px-6"><div class="text-white/70 text-sm font-bold flex items-center gap-2"><span class="material-symbols-outlined">slideshow</span><span id="screen-mode-label">è¼ªæ’­æ¨¡å¼</span></div><div class="flex items-center gap-3"><button class="p-2 text-white/70 hover:text-white hover:bg-white/10 rounded-lg transition" onclick="toggleFullscreen()" title="å…¨è¢å¹•"><span class="material-symbols-outlined" id="fullscreen-icon">fullscreen</span></button><button class="p-2 text-white/70 hover:text-white hover:bg-white/10 rounded-lg transition" onclick="switchTab('helper')" title="è¿”å›"><span class="material-symbols-outlined">close</span></button></div></div>
            <div class="w-full h-full flex items-center justify-center relative bg-black">
                <img class="screen-img clear-state transition-opacity duration-500" id="screen-img" src="">
                <div class="absolute top-16 right-16 z-20 hidden drop-shadow-lg" id="screen-winner-badge"><span class="material-symbols-outlined text-[120px] text-yellow-400" style="text-shadow: 0 8px 20px rgba(0,0,0,0.8);">emoji_events</span></div>
                <div class="absolute inset-0 flex flex-col items-center justify-center bg-black/95 z-30 hidden transition-opacity duration-500" id="intro-overlay"><div class="text-9xl mb-6 animate-bounce">ğŸ¥</div><h2 class="text-7xl md:text-9xl font-black text-white tracking-widest uppercase mb-4 drop-shadow-2xl text-center" id="intro-title">CATEGORY</h2><p class="text-white/60 text-3xl tracking-[0.5em] animate-pulse">WINNER REVEAL</p></div>
                <div class="absolute bottom-16 right-16 bg-black/80 backdrop-blur-xl pl-8 pr-12 py-6 rounded-l-full rounded-tr-3xl border-l-8 border-white/40 flex items-center gap-6 shadow-2xl transition-all duration-700 opacity-0 translate-y-10 z-20 max-w-2xl" id="screen-info"><div class="relative shrink-0"><img class="w-28 h-28 rounded-full border-4 border-white shadow-xl" id="screen-avatar" src=""></div><div class="text-left text-white"><div class="flex items-center gap-2 mb-2"><span class="px-4 py-1 bg-white/30 text-white text-sm rounded-full font-bold uppercase tracking-wider border border-white/20" id="screen-cat-tag">CAT</span></div><div class="font-black text-5xl tracking-wide leading-tight" id="screen-user">User Name</div></div></div>
                <div class="absolute bottom-10 left-10 flex flex-col gap-2 z-50 pointer-events-none" id="toast-container"></div>
            </div>
            <div class="screen-controller absolute left-0 top-0 bottom-0 w-20 hover:w-72 transition-all duration-300 bg-gradient-to-r from-black/90 to-transparent z-50 flex flex-col items-start py-8 pl-4 overflow-y-auto hidden-scrollbar">
                <div class="mb-8 w-full pr-4 flex-shrink-0"><div class="text-white/30 text-[10px] uppercase font-bold mb-2 pl-1">Mode</div><div class="flex flex-col gap-2"><button class="screen-mode-btn active p-3 rounded-lg bg-blue-600 text-white shadow-lg flex items-center gap-3 transition hover:scale-105 w-full whitespace-nowrap overflow-hidden" id="btn-mode-loop" onclick="setScreenMode('loop')"><span class="material-symbols-outlined text-xl flex-shrink-0">repeat</span><span class="font-bold text-sm">è¼ªæ’­æ¨¡å¼</span></button><button class="screen-mode-btn p-3 rounded-lg bg-white/10 text-white flex items-center gap-3 transition hover:scale-105 w-full whitespace-nowrap overflow-hidden" id="btn-mode-ceremony" onclick="setScreenMode('ceremony')"><span class="material-symbols-outlined text-xl flex-shrink-0">podium</span><span class="font-bold text-sm">é ’çå…¸ç¦®</span></button><button class="screen-mode-btn p-3 rounded-lg bg-white/10 text-white flex items-center gap-3 transition hover:scale-105 w-full whitespace-nowrap overflow-hidden disabled:opacity-30 disabled:cursor-not-allowed" disabled id="btn-mode-winner" onclick="setScreenMode('winner_loop')"><span class="material-symbols-outlined text-xl flex-shrink-0">star</span><span class="font-bold text-sm">é ’çå¾Œè¼ªæ’­</span></button></div></div>
                <div class="w-full pr-4 flex-shrink-0" id="controls-ceremony" style="display:none"><div class="flex flex-col gap-3"><div class="text-white/30 text-[10px] uppercase font-bold pl-1">Reveal</div><button class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold shadow-lg flex items-center gap-3 pl-4 border-l-4 border-blue-400" onclick="revealSequence('groom')"><span class="material-symbols-outlined">man</span> æœ€å¸¥æ–°éƒè³</button><button class="w-full py-4 bg-pink-600 hover:bg-pink-500 text-white rounded-lg font-bold shadow-lg flex items-center gap-3 pl-4 border-l-4 border-pink-400" onclick="revealSequence('bride')"><span class="material-symbols-outlined">woman</span> æœ€ç¾æ–°å¨˜è³</button><button class="w-full py-4 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-bold shadow-lg flex items-center gap-3 pl-4 border-l-4 border-amber-400" onclick="revealSequence('creative')"><span class="material-symbols-outlined">lightbulb</span> æœ€ä½³å‰µæ„è³</button></div></div>
                <div class="flex-1 flex flex-col items-center gap-4 w-full pr-4 pt-10" id="controls-loop"><div class="text-white/30 text-[10px] uppercase font-bold pl-1 self-start">Playback</div><button class="p-4 bg-white/20 hover:bg-white/40 rounded-full text-white backdrop-blur" onclick="screenPrev()"><span class="material-symbols-outlined">arrow_upward</span></button><button class="p-5 bg-white text-black rounded-full shadow-lg hover:scale-110 transition" id="btn-play" onclick="togglePlay()"><span class="material-symbols-outlined text-3xl">pause</span></button><button class="p-4 bg-white/20 hover:bg-white/40 rounded-full text-white backdrop-blur" onclick="screenNext()"><span class="material-symbols-outlined">arrow_downward</span></button></div>
            </div>
        </div>

    </main>
</div>

<script>
const categories = { groom: { name: 'æœ€å¸¥æ–°éƒè³', bg: 'bg-blue-100', text: 'text-blue-600', lb: 'bg-blue-600' }, bride: { name: 'æœ€ç¾æ–°å¨˜è³', bg: 'bg-pink-100', text: 'text-pink-600', lb: 'bg-pink-600' }, creative: { name: 'æœ€ä½³å‰µæ„è³', bg: 'bg-amber-100', text: 'text-amber-600', lb: 'bg-amber-600' } };

const avatarStyles = [
    'adventurer', 'adventurer-neutral', 'avataaars', 'avataaars-neutral',
    'big-ears', 'big-ears-neutral', 'big-smile', 'bottts',
    'croodles', 'croodles-neutral', 'fun-emoji', 'lorelei', 
    'micah', 'miniavs', 'notionists', 'open-peeps'
];

const API_URL = "https://fongde-wedding-backend.onrender.com";
const LOCAL_STORAGE_KEY = 'wedding_photos_cache';

let submissions = new Map(), currentRole = 'helper', helperMode = 'pending', coupleFilter = 'all', appState = { submissionsOpen: true, winnersLocked: false }, screenMode = 'loop', screenIndex = 0, playInterval = null, pollInterval = null, synth = null, mouseIdleTimer = null, isFullscreen = false;
let backupFolderHandle = null, backupInterval = null, backedUpPhotos = new Set(), backedUpApproved = new Set();
let isConnected = false;
let failedAttempts = 0;

// ğŸ†• V25.1: Lightbox å°èˆªç”¨çš„å¿«ç…§åˆ—è¡¨
let lbSnapshotList = [];
let lbSnapshotIndex = 0;

function getRandomAvatar(seed) { 
    const hash = Math.abs(hashCode(seed || 'default')); 
    const style = avatarStyles[hash % avatarStyles.length];
    return `https://api.dicebear.com/7.x/${style}/svg?seed=${seed}&backgroundColor=b6e3f4,c0aede,d1d4f9,ffd5dc,ffdfbf`; 
}
function hashCode(str) { let hash = 0; for (let i = 0; i < str.length; i++) { hash = ((hash << 5) - hash) + str.charCodeAt(i); hash = hash & hash; } return hash; }

window.addEventListener('beforeunload', e => { if (submissions.size > 0) { e.preventDefault(); e.returnValue = 'ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿæœªå„²å­˜çš„è³‡æ–™å¯èƒ½æœƒéºå¤±ã€‚'; return e.returnValue; } });
document.addEventListener('keydown', e => { if (e.key === 'Escape' && !document.getElementById('lightbox').classList.contains('hidden')) closeLightbox(null, true); });

// ğŸ†• V25.1: æœ¬åœ°å¿«å–åŠŸèƒ½
function saveToLocalCache() {
    try {
        const data = {
            submissions: Array.from(submissions.entries()),
            appState: appState,
            timestamp: Date.now()
        };
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
    } catch(e) { console.warn('æœ¬åœ°å¿«å–å„²å­˜å¤±æ•—', e); }
}

function loadFromLocalCache() {
    try {
        const cached = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (cached) {
            const data = JSON.parse(cached);
            // åªä½¿ç”¨ 1 å°æ™‚å…§çš„å¿«å–
            if (Date.now() - data.timestamp < 60 * 60 * 1000) {
                submissions = new Map(data.submissions);
                if (data.appState) appState = data.appState;
                console.log(`ğŸ“¦ å¾æœ¬åœ°å¿«å–è¼‰å…¥ ${submissions.size} å¼µç…§ç‰‡`);
                return true;
            }
        }
    } catch(e) { console.warn('æœ¬åœ°å¿«å–è¼‰å…¥å¤±æ•—', e); }
    return false;
}

function startApp() { 
    document.getElementById('intro-modal').style.display = 'none'; 
    initAudio(); 
    initScreenAutoHide(); 
    
    // ğŸ†• V25.1: å…ˆå˜—è©¦è¼‰å…¥æœ¬åœ°å¿«å–
    if (loadFromLocalCache()) {
        refreshAll();
        document.getElementById('helper-msg').innerText = `å·²è¼‰å…¥æœ¬åœ°å¿«å– ${submissions.size} å¼µï¼Œæ­£åœ¨åŒæ­¥...`;
    }
    
    document.getElementById('sys-status').innerText = "é€£ç·šä¸­..."; 
    document.getElementById('sys-status').className = "font-bold text-yellow-600"; 
    document.getElementById('status-dot').className = "w-2 h-2 bg-yellow-500 rounded-full animate-pulse"; 
    startPolling(); 
    refreshAll(); 
    startScreenLoop(); 
}

function initScreenAutoHide() { 
    const sv = document.getElementById('view-screen'); 
    sv.addEventListener('mousemove', () => { showScreenControls(); resetMouseIdleTimer(); }); 
    sv.addEventListener('mouseleave', () => clearTimeout(mouseIdleTimer)); 
    document.addEventListener('fullscreenchange', () => { isFullscreen = !!document.fullscreenElement; document.getElementById('fullscreen-icon').textContent = isFullscreen ? 'fullscreen_exit' : 'fullscreen'; }); 
}
function showScreenControls() { document.getElementById('view-screen').classList.remove('screen-controls-hidden'); }
function hideScreenControls() { document.getElementById('view-screen').classList.add('screen-controls-hidden'); }
function resetMouseIdleTimer() { clearTimeout(mouseIdleTimer); mouseIdleTimer = setTimeout(hideScreenControls, 1000); }
function toggleFullscreen() { const sv = document.getElementById('view-screen'); if (!document.fullscreenElement) sv.requestFullscreen().catch(console.error); else document.exitFullscreen(); }
async function initAudio() { await Tone.start(); synth = new Tone.PolySynth(Tone.Synth).toDestination(); synth.volume.value = -6; }
function refreshAll() { renderHelper(); renderCouple(); updateProgress(); document.getElementById('debug-local').innerText = `${submissions.size} å¼µ`; }

function manualReconnect() {
    failedAttempts = 0;
    document.getElementById('btn-reconnect').classList.add('hidden');
    document.getElementById('sys-status').innerText = "é‡æ–°é€£ç·šä¸­...";
    document.getElementById('sys-status').className = "font-bold text-yellow-600";
    document.getElementById('status-dot').className = "w-2 h-2 bg-yellow-500 rounded-full animate-pulse";
    fetchData(true);
}

// ğŸ†• V25.1: ç¸®çŸ­è¼ªè©¢é–“éš”åˆ° 2 ç§’
async function startPolling() { await fetchData(true); await checkTestMode(); await checkSubmissionStatus(); pollInterval = setInterval(fetchData, 2000); }
async function checkTestMode() { try { const res = await fetch(`${API_URL}/api/test-mode`); if(res.ok) { const data = await res.json(); updateTestModeUI(data.testMode); } } catch(e) {} }
async function toggleTestMode() { const btn = document.getElementById('btn-toggle-test-mode'); btn.disabled = true; try { const res = await fetch(`${API_URL}/api/test-mode`, { method: 'POST' }); if(res.ok) { const data = await res.json(); updateTestModeUI(data.testMode); alert(data.message); } } catch(e) { alert('é€£ç·šå¤±æ•—'); } btn.disabled = false; }
function updateTestModeUI(isTestMode) { const badge = document.getElementById('test-mode-badge'), btn = document.getElementById('btn-toggle-test-mode'), icon = document.getElementById('test-mode-icon'), btnText = document.getElementById('test-mode-btn-text'); if(isTestMode) { badge.textContent = 'å·²é–‹å•Ÿ'; badge.className = 'text-xs font-bold px-2 py-1 rounded bg-amber-500 text-white'; btn.className = 'w-full py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition bg-amber-500 hover:bg-amber-600 text-white'; icon.textContent = 'toggle_on'; btnText.textContent = 'é—œé–‰æ¸¬è©¦æ¨¡å¼'; } else { badge.textContent = 'å·²é—œé–‰'; badge.className = 'text-xs font-bold px-2 py-1 rounded bg-slate-200 text-slate-600'; btn.className = 'w-full py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition bg-slate-200 hover:bg-slate-300 text-slate-700'; icon.textContent = 'toggle_off'; btnText.textContent = 'é–‹å•Ÿæ¸¬è©¦æ¨¡å¼'; } }
async function checkSubmissionStatus() { try { const res = await fetch(`${API_URL}/api/submission-status`); if(res.ok) { const data = await res.json(); updateSubmissionStatusUI(data.submissionsOpen); } } catch(e) {} }
async function toggleSubmissionAPI() { const btn = document.getElementById('btn-toggle-submission'); btn.disabled = true; try { const res = await fetch(`${API_URL}/api/submission-status`, { method: 'POST' }); if(res.ok) { const data = await res.json(); updateSubmissionStatusUI(data.submissionsOpen); alert(data.message); } } catch(e) { alert('é€£ç·šå¤±æ•—'); } btn.disabled = false; }
function updateSubmissionStatusUI(isOpen) { const badge = document.getElementById('submission-status-badge'), btn = document.getElementById('btn-toggle-submission'), icon = document.getElementById('submission-icon'), btnText = document.getElementById('submission-btn-text'); if(isOpen) { badge.textContent = 'é–‹æ”¾ä¸­'; badge.className = 'text-xs font-bold px-2 py-1 rounded bg-green-500 text-white'; btn.className = 'w-full py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition bg-green-500 hover:bg-green-600 text-white'; icon.textContent = 'toggle_on'; btnText.textContent = 'æš«åœå ±å'; } else { badge.textContent = 'å·²æš«åœ'; badge.className = 'text-xs font-bold px-2 py-1 rounded bg-red-500 text-white'; btn.className = 'w-full py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition bg-red-500 hover:bg-red-600 text-white'; icon.textContent = 'toggle_off'; btnText.textContent = 'æ¢å¾©å ±å'; } }

async function fetchData(isFirst = false) { 
    try { 
        const res = await fetch(`${API_URL}/api/photos`); 
        if(!res.ok) throw new Error(`HTTP ${res.status}`); 
        const data = await res.json(); 
        
        // ğŸ†• V25.1: åˆä½µå¾Œç«¯è³‡æ–™ï¼Œä¿ç•™æœ¬åœ°ç‹€æ…‹è®Šæ›´
        const newSubmissions = new Map();
        data.forEach(remote => { 
            const uid = remote.odialog || remote.userId || remote.id.toString(); 
            const avatarSeed = remote.odialog || remote.userId || uid;
            const existing = submissions.get(uid);
            newSubmissions.set(uid, {
                ...remote, 
                odialog: uid,
                avatar: (existing && existing.avatar) || remote.avatar || getRandomAvatar(avatarSeed),
                // ä½¿ç”¨å¾Œç«¯ç‹€æ…‹ï¼ˆå¤šè¨­å‚™åŒæ­¥ï¼‰
                status: remote.status || (existing ? existing.status : 'pending'),
                isWinner: remote.isWinner !== undefined ? remote.isWinner : (existing ? existing.isWinner : false)
            });
        });
        
        const hasChanges = newSubmissions.size !== submissions.size || 
            Array.from(newSubmissions.entries()).some(([k, v]) => {
                const old = submissions.get(k);
                return !old || old.status !== v.status || old.isWinner !== v.isWinner || old.timestamp !== v.timestamp;
            });
        
        submissions = newSubmissions;
        
        // ğŸ†• V25.1: å„²å­˜åˆ°æœ¬åœ°å¿«å–
        saveToLocalCache();
        
        fetch(`${API_URL}/api/status`).then(r=>r.json()).then(h=>{ 
            if(h) { 
                if(h.memory) document.getElementById('debug-mem').innerText = h.memory.heapUsed; 
                document.getElementById('debug-photos').innerText = `${h.photos} å¼µ`; 
                if(h.testMode !== undefined) updateTestModeUI(h.testMode); 
                if(h.submissionsOpen !== undefined) updateSubmissionStatusUI(h.submissionsOpen); 
            } 
        }).catch(()=>{}); 
        
        if(isFirst || !isConnected) { 
            isConnected = true;
            failedAttempts = 0;
            document.getElementById('btn-reconnect').classList.add('hidden');
            document.getElementById('sys-status').innerText = "æ­£å¼é€£ç·š"; 
            document.getElementById('sys-status').className = "font-bold text-green-600"; 
            document.getElementById('status-dot').className = "w-2 h-2 bg-green-500 rounded-full animate-pulse"; 
            document.getElementById('helper-msg').innerText = "é€£ç·šæˆåŠŸï¼ç­‰å¾…æ–°ç…§ç‰‡ä¸­..."; 
        } 
        
        if(hasChanges) refreshAll(); 
    } catch(e) { 
        console.error(e); 
        isConnected = false;
        failedAttempts++;
        document.getElementById('sys-status').innerText = "é€£ç·šä¸­æ–·"; 
        document.getElementById('sys-status').className = "font-bold text-red-600"; 
        document.getElementById('status-dot').className = "w-2 h-2 bg-red-500 rounded-full"; 
        document.getElementById('helper-msg').innerText = `é€£ç·šå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å¿«å– (${submissions.size} å¼µ)`;
        if(failedAttempts >= 2) {
            document.getElementById('btn-reconnect').classList.remove('hidden');
        }
    } 
}

function resetSystem(){ if(confirm('âŒ è­¦å‘Šï¼šåš´é‡æ“ä½œï¼\n\né€™å°‡æ¸…ç©ºã€æ‰€æœ‰ã€‘ç…§ç‰‡èˆ‡åå–®ã€‚\nç¢ºå®šè¦å…¨éƒ¨é‡ç½®ï¼Ÿ')){ if(confirm('å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦åˆªé™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) { submissions.clear(); appState.winnersLocked=false; document.getElementById('btn-mode-winner').disabled=true; document.getElementById('btn-mode-winner').classList.add('opacity-30','cursor-not-allowed'); localStorage.removeItem(LOCAL_STORAGE_KEY); refreshAll(); setScreenMode('loop'); fetch(`${API_URL}/api/clear`, {method:'POST'}).catch(console.error); } } }

function setHelperMode(m){ helperMode=m; document.getElementById('btn-helper-pending').className = m==='pending' ? "px-3 py-1 text-xs font-bold rounded shadow bg-white text-slate-800" : "px-3 py-1 text-xs font-bold rounded text-slate-500 hover:bg-white"; document.getElementById('btn-helper-trash').className = m==='trash' ? "px-3 py-1 text-xs font-bold rounded shadow bg-white text-red-600 flex items-center gap-1" : "px-3 py-1 text-xs font-bold rounded text-slate-500 hover:bg-white flex items-center gap-1"; renderHelper(); }
function renderHelper(){ const g = document.getElementById('helper-grid-content'); g.innerHTML=''; const list = Array.from(submissions.values()).filter(p => helperMode==='pending' ? p.status==='pending' : p.status==='rejected').sort((a,b) => b.timestamp - a.timestamp); document.getElementById('helper-empty').classList.toggle('hidden', list.length > 0); list.forEach(p => { const photoKey = p.odialog || p.userId; const div = document.createElement('div'); div.className = 'bg-slate-100 rounded-xl overflow-hidden group relative cursor-zoom-in pop-in flex flex-col border border-slate-200'; div.onclick = () => openLightbox(photoKey); div.innerHTML = `<div class="photo-preview relative"><img src="${p.url}" class="max-w-full max-h-full object-contain"><div class="absolute top-2 left-2 px-2 py-1 rounded text-[10px] font-bold ${categories[p.cat].bg} ${categories[p.cat].text} shadow-sm z-10 new-tag">${categories[p.cat].name}</div></div><div class="p-2 bg-white flex justify-between items-center text-xs border-t h-10"><div class="truncate text-slate-600 font-medium w-full">${p.uploader}</div>${helperMode==='trash' ? '<span class="text-red-400 font-bold text-[10px] shrink-0">å·²åˆªé™¤</span>' : ''}</div>`; g.appendChild(div); }); }

async function updateStatus(photoKey, s){ 
    const p = submissions.get(photoKey); 
    if(p){ 
        p.status = s; 
        submissions.set(photoKey, p); 
        saveToLocalCache();
        refreshAll(); 
        if(s === 'approved') showToast(p.uploader); 
        
        try {
            await fetch(`${API_URL}/api/photos/${photoKey}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: s })
            });
        } catch(e) { console.error('ç‹€æ…‹åŒæ­¥å¤±æ•—', e); }
    } 
}

function updateProgress(){ const l = Array.from(submissions.values()).filter(p => p.status==='approved' || p.status==='winner'); const c = {groom:0, bride:0, creative:0}; l.forEach(p => c[p.cat]++); ['groom','bride','creative'].forEach(k => { document.getElementById(`prog-${k}`).textContent = `${k==='groom'?'ğŸ¤µ':(k==='bride'?'ğŸ‘°':'ğŸ’¡')} ${c[k]}`; }); }

function filterCouple(c){ coupleFilter = c; document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.cat === c)); renderCouple(); }
function renderCouple(){ const g = document.getElementById('couple-grid-content'); g.innerHTML=''; let list = Array.from(submissions.values()).filter(p => p.status==='approved' || p.status==='winner'); if(coupleFilter !== 'all') list = list.filter(p => p.cat === coupleFilter); list.sort((a,b) => b.timestamp - a.timestamp); list.forEach(p => { const photoKey = p.odialog || p.userId; const div = document.createElement('div'); div.className = `rounded-xl overflow-hidden relative cursor-pointer group bg-slate-100 shadow-sm border ${p.isWinner?'ring-4 ring-pink-500 z-10':''}`; div.onclick = () => openLightbox(photoKey); div.innerHTML = `<div class="photo-preview relative"><img src="${p.url}" class="max-w-full max-h-full object-contain">${p.isWinner?'<div class="absolute inset-0 bg-pink-500/20 flex items-center justify-center pointer-events-none"><span class="material-symbols-outlined text-white text-5xl drop-shadow-lg">trophy</span></div>':''}</div><div class="p-2 bg-white flex justify-between text-xs font-bold text-slate-600 border-t"><span>${categories[p.cat].name}</span> <span class="truncate max-w-[80px]">${p.uploader}</span></div>`; g.appendChild(div); }); const w = Array.from(submissions.values()).filter(p => p.isWinner); ['groom','bride','creative'].forEach(c => { const x = w.find(i => i.cat === c); document.getElementById(`stat-winner-${c}`).innerHTML = x ? `<div class="flex items-center gap-2 text-${categories[c].text.split('-')[1]}-700 font-bold"><span class="material-symbols-outlined text-sm">check_circle</span> ${categories[c].name}</div> <img src="${x.avatar}" class="w-5 h-5 rounded-full border">` : `<span>${categories[c].name}</span> <span class="text-slate-300">--</span>`; }); const btn = document.getElementById('btn-lock-winners'); if(w.length === 3 && !appState.winnersLocked){ btn.disabled=false; btn.className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg animate-pulse flex items-center gap-2 cursor-pointer"; btn.innerHTML='<span class="material-symbols-outlined">verified</span> ç¢ºèªä¸¦é–å®š'; } else if(appState.winnersLocked){ btn.disabled=true; btn.className="bg-slate-800 text-white/50 px-6 py-3 rounded-xl font-bold flex items-center gap-2 cursor-not-allowed"; btn.innerHTML='<span class="material-symbols-outlined">lock</span> åå–®å·²é–å®š'; } else { btn.disabled=true; btn.className="bg-slate-200 text-slate-400 px-6 py-3 rounded-xl font-bold flex items-center gap-2 cursor-not-allowed"; } }

async function toggleWinner(photoKey){ 
    if(appState.winnersLocked) return; 
    const p = submissions.get(photoKey); 
    if(!p) return; 
    
    const newWinnerState = !p.isWinner;
    
    if(newWinnerState) {
        for(const [k, x] of submissions) {
            if(x.cat === p.cat && x.isWinner) { 
                x.isWinner = false; 
                submissions.set(k, x);
                fetch(`${API_URL}/api/photos/${k}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isWinner: false })
                }).catch(console.error);
            }
        }
    }
    
    p.isWinner = newWinnerState;
    submissions.set(photoKey, p); 
    saveToLocalCache();
    refreshAll();
    
    try {
        await fetch(`${API_URL}/api/photos/${photoKey}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ isWinner: newWinnerState })
        });
    } catch(e) { console.error('å† è»ç‹€æ…‹åŒæ­¥å¤±æ•—', e); }
}

async function returnToPending(photoKey) { 
    const p = submissions.get(photoKey); 
    if(p) { 
        p.status = 'pending'; 
        p.isWinner = false; 
        submissions.set(photoKey, p); 
        saveToLocalCache();
        refreshAll(); 
        closeLightbox(null, true);
        
        try {
            await fetch(`${API_URL}/api/photos/${photoKey}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'pending', isWinner: false })
            });
        } catch(e) { console.error('é€€å›åˆé¸åŒæ­¥å¤±æ•—', e); }
    } 
}

// ğŸ†• V25.1: é–‹å•Ÿ Lightbox æ™‚å»ºç«‹å¿«ç…§åˆ—è¡¨
function getLightboxList(){ 
    if(currentRole === 'helper') 
        return Array.from(submissions.values()).filter(p => helperMode==='pending'?p.status==='pending':p.status==='rejected').sort((a,b)=>b.timestamp-a.timestamp); 
    else { 
        let l = Array.from(submissions.values()).filter(p => p.status==='approved' || p.status==='winner').sort((a,b)=>b.timestamp-a.timestamp); 
        if(coupleFilter !== 'all') l = l.filter(p => p.cat === coupleFilter); 
        return l; 
    } 
}

function openLightbox(photoKey){ 
    const p = submissions.get(photoKey); 
    if(!p) return; 
    
    // ğŸ†• V25.1: å»ºç«‹å¿«ç…§åˆ—è¡¨ï¼Œå›ºå®šå°èˆªé †åº
    lbSnapshotList = getLightboxList().map(x => x.odialog || x.userId);
    lbSnapshotIndex = lbSnapshotList.indexOf(photoKey);
    if(lbSnapshotIndex === -1) lbSnapshotIndex = 0;
    
    const lb = document.getElementById('lightbox'); 
    document.getElementById('lb-img').src = p.url; 
    const catBadge = document.getElementById('lb-cat-badge'); 
    catBadge.innerText = categories[p.cat].name; 
    catBadge.className = `inline-block px-4 py-1.5 rounded-full text-base font-bold text-white mb-2 shadow-lg ${categories[p.cat].lb}`; 
    document.getElementById('lb-user-display').innerText = p.uploader; 
    document.getElementById('lb-feedback').classList.add('opacity-0'); 
    renderLbActions(p); 
    lb.classList.remove('hidden'); 
    lb.dataset.uid = photoKey; 
    requestAnimationFrame(() => lb.classList.remove('opacity-0')); 
}

function renderLbActions(p){ const d = document.getElementById('lb-actions'); const photoKey = p.odialog || p.userId; if(currentRole === 'helper') { if(helperMode === 'pending') { d.innerHTML = `<button onclick="event.stopPropagation(); lbDecision('${photoKey}','rejected')" class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-400 text-white shadow-xl flex items-center justify-center transition hover:scale-110"><span class="material-symbols-outlined text-3xl">close</span></button><button onclick="event.stopPropagation(); lbDecision('${photoKey}','approved')" class="w-16 h-16 rounded-full bg-green-500 hover:bg-green-400 text-white shadow-xl flex items-center justify-center transition hover:scale-110"><span class="material-symbols-outlined text-3xl">check</span></button>`; } else { d.innerHTML = `<button onclick="event.stopPropagation(); lbDecision('${photoKey}','pending')" class="px-6 py-2 rounded-full bg-blue-500 text-white font-bold shadow">é‚„åŸ</button>`; } } else { if(appState.winnersLocked) { d.innerHTML = `<span class="text-white font-bold">å·²é–å®š</span>`; } else { let btns = `<button onclick="event.stopPropagation(); returnToPending('${photoKey}')" class="px-5 py-3 rounded-full bg-slate-500 hover:bg-slate-400 text-white font-bold shadow-lg flex items-center gap-2"><span class="material-symbols-outlined">undo</span> é€€å›åˆé¸</button>`; btns += p.isWinner ? `<button onclick="event.stopPropagation(); toggleWinner('${photoKey}');openLightbox('${photoKey}')" class="px-6 py-3 rounded-full bg-yellow-400 text-black font-bold shadow-lg flex items-center gap-2"><span class="material-symbols-outlined">trophy</span> å–æ¶ˆå† è»</button>` : `<button onclick="event.stopPropagation(); toggleWinner('${photoKey}');openLightbox('${photoKey}')" class="px-6 py-3 rounded-full bg-white text-pink-600 font-bold shadow-lg flex items-center gap-2"><span class="material-symbols-outlined">trophy</span> é¸ç‚ºå† è»</button>`; d.innerHTML = btns; } } }

// ğŸ†• V25.1: ä¿®æ­£å°èˆªé‚è¼¯ - ä½¿ç”¨å¿«ç…§åˆ—è¡¨å›ºå®šé †åº
function lbDecision(photoKey, s){ 
    document.getElementById('lb-feedback-icon').innerText = s==='approved'?'check':(s==='pending'?'restore':'close'); 
    document.getElementById('lb-feedback').classList.remove('opacity-0'); 
    updateStatus(photoKey, s); 
    
    if(currentRole === 'helper' && helperMode === 'pending') { 
        setTimeout(() => { 
            // ğŸ†• V25.1: ç§»å‹•åˆ°å¿«ç…§åˆ—è¡¨çš„ä¸‹ä¸€å¼µï¼ˆä¸æ˜¯æ–°åˆ—è¡¨çš„ç¬¬ä¸€å¼µï¼‰
            lbSnapshotIndex++;
            if(lbSnapshotIndex < lbSnapshotList.length) {
                const nextKey = lbSnapshotList[lbSnapshotIndex];
                const nextPhoto = submissions.get(nextKey);
                // ç¢ºä¿ä¸‹ä¸€å¼µé‚„æ˜¯ pending ç‹€æ…‹ï¼ˆå¯èƒ½å·²è¢«å…¶ä»–è¨­å‚™è™•ç†ï¼‰
                if(nextPhoto && nextPhoto.status === 'pending') {
                    openLightboxByKey(nextKey);
                } else {
                    // å¦‚æœä¸‹ä¸€å¼µå·²ä¸æ˜¯ pendingï¼Œç¹¼çºŒå¾€å¾Œæ‰¾
                    findNextPendingInSnapshot();
                }
            } else {
                closeLightbox(null, true);
            }
        }, 500); 
    } else setTimeout(() => closeLightbox(null, true), 500); 
}

// ğŸ†• V25.1: åœ¨å¿«ç…§ä¸­æ‰¾ä¸‹ä¸€å€‹ pending
function findNextPendingInSnapshot() {
    while(lbSnapshotIndex < lbSnapshotList.length) {
        const key = lbSnapshotList[lbSnapshotIndex];
        const photo = submissions.get(key);
        if(photo && photo.status === 'pending') {
            openLightboxByKey(key);
            return;
        }
        lbSnapshotIndex++;
    }
    closeLightbox(null, true);
}

// ğŸ†• V25.1: ç›´æ¥é–‹å•ŸæŒ‡å®š key çš„ç…§ç‰‡ï¼ˆä¸é‡å»ºå¿«ç…§ï¼‰
function openLightboxByKey(photoKey) {
    const p = submissions.get(photoKey); 
    if(!p) { closeLightbox(null, true); return; }
    
    const lb = document.getElementById('lightbox'); 
    document.getElementById('lb-img').src = p.url; 
    const catBadge = document.getElementById('lb-cat-badge'); 
    catBadge.innerText = categories[p.cat].name; 
    catBadge.className = `inline-block px-4 py-1.5 rounded-full text-base font-bold text-white mb-2 shadow-lg ${categories[p.cat].lb}`; 
    document.getElementById('lb-user-display').innerText = p.uploader; 
    document.getElementById('lb-feedback').classList.add('opacity-0'); 
    renderLbActions(p); 
    lb.dataset.uid = photoKey; 
}

// ğŸ†• V25.1: å°èˆªä¹Ÿä½¿ç”¨å¿«ç…§åˆ—è¡¨
function lbNav(dir){ 
    lbSnapshotIndex += dir;
    if(lbSnapshotIndex < 0) lbSnapshotIndex = lbSnapshotList.length - 1;
    if(lbSnapshotIndex >= lbSnapshotList.length) lbSnapshotIndex = 0;
    
    const nextKey = lbSnapshotList[lbSnapshotIndex];
    if(nextKey) openLightboxByKey(nextKey);
}

function closeLightbox(e, force){ if(force || (e && e.target.id === 'lightbox')){ document.getElementById('lightbox').classList.add('opacity-0'); setTimeout(() => document.getElementById('lightbox').classList.add('hidden'), 300); } }

function showToast(n){ const c = document.getElementById('toast-container'); const d = document.createElement('div'); d.className = 'bg-white/90 backdrop-blur-md px-6 py-3 rounded-r-full rounded-tl-full shadow-xl border-l-4 border-pink-500 flex items-center gap-3 toast-enter'; d.innerHTML = `<span class="material-symbols-outlined text-pink-500 animate-bounce">celebration</span> <div><div class="text-[10px] text-slate-500 font-bold uppercase">å…¥åœé€šçŸ¥</div><div class="font-bold text-slate-800">æ­å–œ ${n} é€²å…¥æ±ºé¸ï¼</div></div>`; c.appendChild(d); requestAnimationFrame(() => d.className = 'bg-white/90 backdrop-blur-md px-6 py-3 rounded-r-full rounded-tl-full shadow-xl border-l-4 border-pink-500 flex items-center gap-3 toast-active'); setTimeout(() => { d.className = 'bg-white/90 backdrop-blur-md px-6 py-3 rounded-r-full rounded-tl-full shadow-xl border-l-4 border-pink-500 flex items-center gap-3 toast-exit'; setTimeout(() => d.remove(), 500); }, 4000); }
function setScreenMode(m){ screenMode = m; const o = document.getElementById('intro-overlay'), i = document.getElementById('screen-img'), b = document.getElementById('screen-winner-badge'); document.querySelectorAll('.screen-mode-btn').forEach(btn => { btn.classList.remove('active', 'bg-blue-600', 'bg-pink-600', 'bg-amber-500'); btn.classList.add('bg-white/10'); }); document.getElementById('screen-mode-label').textContent = { loop: 'è¼ªæ’­æ¨¡å¼', ceremony: 'é ’çå…¸ç¦®', winner_loop: 'é ’çå¾Œè¼ªæ’­' }[m] || 'è¼ªæ’­æ¨¡å¼'; if(m === 'loop') { document.getElementById('btn-mode-loop').classList.remove('bg-white/10'); document.getElementById('btn-mode-loop').classList.add('active', 'bg-blue-600'); } else if(m === 'ceremony') { document.getElementById('btn-mode-ceremony').classList.remove('bg-white/10'); document.getElementById('btn-mode-ceremony').classList.add('active', 'bg-pink-600'); } else if(m === 'winner_loop') { document.getElementById('btn-mode-winner').classList.remove('bg-white/10'); document.getElementById('btn-mode-winner').classList.add('active', 'bg-amber-500'); } document.getElementById('controls-loop').style.display = m!=='ceremony' ? 'flex' : 'none'; document.getElementById('controls-ceremony').style.display = m==='ceremony' ? 'flex' : 'none'; if(m === 'ceremony') { stopScreenLoop(); i.style.opacity = 0.2; o.classList.remove('hidden'); document.getElementById('intro-title').innerText="é ’çå…¸ç¦®"; } else { o.classList.add('hidden'); b.classList.add('hidden'); i.className='screen-img clear-state transition-opacity duration-500'; i.style.opacity=1; startScreenLoop(); } }
function updateScreen(){ let list; if(screenMode === 'winner_loop') { list = Array.from(submissions.values()).filter(p => p.status === 'approved' || p.isWinner); } else { list = Array.from(submissions.values()).filter(p => p.status==='approved' || p.status==='winner').sort((a,b) => b.timestamp - a.timestamp); } if(list.length === 0) return; if(screenIndex >= list.length) screenIndex = 0; if(screenIndex < 0) screenIndex = list.length - 1; const p = list[screenIndex]; const photoKey = p.odialog || p.userId; const img = document.getElementById('screen-img'); const n = document.getElementById('screen-info'); const b = document.getElementById('screen-winner-badge'); img.style.opacity=0; n.style.opacity=0; b.classList.add('hidden'); setTimeout(() => { img.src = p.url; document.getElementById('screen-cat-tag').innerText = categories[p.cat].name; document.getElementById('screen-user').innerText = p.uploader; document.getElementById('screen-avatar').src = p.avatar || getRandomAvatar(photoKey); img.onload = () => { img.style.opacity=1; n.style.opacity=1; n.style.transform='translate(0,0)'; if(screenMode === 'winner_loop' && appState.winnersLocked && p.isWinner) { b.classList.remove('hidden'); img.style.transform="scale(1.02)"; } else { b.classList.add('hidden'); img.style.transform="scale(1)"; } }; }, 500); }
function startScreenLoop(){ if(playInterval) clearInterval(playInterval); playInterval = setInterval(() => { screenIndex++; updateScreen(); }, 5000); document.getElementById('btn-play').innerHTML='<span class="material-symbols-outlined text-3xl">pause</span>'; }
function stopScreenLoop(){ if(playInterval) clearInterval(playInterval); playInterval = null; document.getElementById('btn-play').innerHTML='<span class="material-symbols-outlined text-3xl">play_arrow</span>'; }
function togglePlay(){ if(playInterval) stopScreenLoop(); else startScreenLoop(); }
function screenNext(){ screenIndex++; updateScreen(); }
function screenPrev(){ screenIndex--; updateScreen(); }

function revealSequence(cat){ 
    const w = Array.from(submissions.values()).find(p => p.isWinner && p.cat === cat); 
    if(!w) { alert('è«‹å…ˆåœ¨ã€Œæ–°äººã€é é¢é¸æ“‡æ­¤é¡åˆ¥çš„å† è»ï¼'); return; }
    const photoKey = w.odialog || w.userId; 
    const img = document.getElementById('screen-img'); 
    const o = document.getElementById('intro-overlay'); 
    document.getElementById('screen-info').style.opacity=0; 
    document.getElementById('screen-winner-badge').classList.add('hidden'); 
    img.src = w.url; 
    img.className = 'screen-img blur-state'; 
    img.style.opacity = 0.3; 
    o.classList.remove('hidden'); 
    document.getElementById('intro-title').innerText = categories[cat].name; 
    
    setTimeout(() => { 
        o.classList.add('hidden'); 
        img.className = 'screen-img clear-state'; 
        img.style.opacity = 1; 
        if(synth) { 
            const now = Tone.now(); 
            synth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n", now); 
            synth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "2n", now + 0.5); 
        } 
        const f = document.createElement('div'); 
        f.className = 'absolute inset-0 bg-white z-50'; 
        document.getElementById('view-screen').appendChild(f); 
        f.animate([{opacity:1}, {opacity:0}], {duration:1000}).onfinish = () => f.remove(); 
        setTimeout(() => { 
            document.getElementById('screen-user').innerText = w.uploader; 
            document.getElementById('screen-cat-tag').innerText = categories[cat].name; 
            document.getElementById('screen-avatar').src = w.avatar || getRandomAvatar(photoKey); 
            document.getElementById('screen-info').style.opacity = 1; 
            document.getElementById('screen-winner-badge').classList.remove('hidden'); 
            for(let k=0; k<60; k++){ 
                const c = document.createElement('div'); 
                c.className = 'confetti'; 
                c.style.left = Math.random() * 100 + 'vw'; 
                c.style.backgroundColor = ['#f00', '#0f0', '#00f', '#ff0'][Math.floor(Math.random() * 4)]; 
                c.style.animationDuration = Math.random() * 2 + 2 + 's'; 
                document.getElementById('view-screen').appendChild(c); 
                setTimeout(() => c.remove(), 4000); 
            } 
        }, 800); 
    }, 6500);
}

function openConfirmModal(){ ['groom','bride','creative'].forEach(c => { const w = Array.from(submissions.values()).find(x => x.isWinner && x.cat === c); if(w) { document.getElementById(`confirm-card-${c}`).innerHTML = `<div class="font-bold text-${categories[c].text.split('-')[1]}-800 mb-2">${categories[c].name}</div><div class="w-full aspect-[4/3] bg-slate-100 flex items-center justify-center rounded-lg mb-2 shadow-inner overflow-hidden border"><img src="${w.url}" class="max-w-full max-h-full object-contain"></div><div class="font-bold text-slate-700">${w.uploader}</div>`; } }); document.getElementById('confirm-modal').classList.remove('hidden'); }
function closeConfirmModal(){ document.getElementById('confirm-modal').classList.add('hidden'); }
function finalizeWinners(){ appState.winnersLocked = true; saveToLocalCache(); closeConfirmModal(); refreshAll(); document.getElementById('btn-mode-winner').disabled = false; document.getElementById('btn-mode-winner').classList.remove('opacity-30', 'cursor-not-allowed'); alert('âœ… åå–®å·²é–å®šï¼\n\nè«‹æ‰‹å‹•åˆ‡æ›åˆ°ã€ŒæŠ•å½±ã€é é¢ï¼Œé¸æ“‡ã€Œé ’çå…¸ç¦®ã€æˆ–ã€Œé ’çå¾Œè¼ªæ’­ã€æ¨¡å¼ã€‚'); }

function switchTab(t){ currentRole = t === 'couple' ? 'couple' : 'helper'; document.querySelectorAll('.view-section').forEach(e => e.classList.add('hidden')); const viewEl = document.getElementById('view-' + t); viewEl.classList.remove('hidden'); if(t !== 'screen') viewEl.classList.add('flex'); document.getElementById('main-header').style.display = t === 'screen' ? 'none' : 'flex'; ['helper', 'couple', 'screen'].forEach(tab => { const btn = document.getElementById('tab-' + tab); if (tab === t) { btn.classList.add('bg-white', 'shadow-sm', 'text-slate-800', 'ring-1', 'ring-slate-200'); btn.classList.remove('text-slate-500', 'hover:text-slate-900'); } else { btn.classList.remove('bg-white', 'shadow-sm', 'text-slate-800', 'ring-1', 'ring-slate-200'); btn.classList.add('text-slate-500', 'hover:text-slate-900'); } }); if(t === 'screen') { updateScreen(); resetMouseIdleTimer(); } }

async function selectBackupFolder() { try { if (!('showDirectoryPicker' in window)) { alert('ç€è¦½å™¨ä¸æ”¯æ´ï¼Œè«‹ä½¿ç”¨ Chrome 86+'); return; } backupFolderHandle = await window.showDirectoryPicker({ mode: 'readwrite' }); await backupFolderHandle.getDirectoryHandle('all', { create: true }); await backupFolderHandle.getDirectoryHandle('approved', { create: true }); document.getElementById('backup-folder-text').textContent = 'âœ“ å·²é¸æ“‡'; document.getElementById('btn-toggle-backup').disabled = false; document.getElementById('backup-status-badge').textContent = 'å°±ç·’'; document.getElementById('backup-status-badge').className = 'text-xs font-bold px-2 py-1 rounded bg-blue-500 text-white'; } catch(e) { if(e.name !== 'AbortError') alert('é¸æ“‡å¤±æ•—: ' + e.message); } }

// ğŸ†• V25.1: å‚™ä»½é–“éš”æ”¹ç‚º 90 ç§’
function toggleAutoBackup() { if(backupInterval) { clearInterval(backupInterval); backupInterval = null; document.getElementById('backup-toggle-icon').textContent = 'play_arrow'; document.getElementById('backup-status-badge').textContent = 'å·²æš«åœ'; document.getElementById('backup-status-badge').className = 'text-xs font-bold px-2 py-1 rounded bg-slate-400 text-white'; } else { runBackup(); backupInterval = setInterval(runBackup, 90 * 1000); document.getElementById('backup-toggle-icon').textContent = 'pause'; document.getElementById('backup-status-badge').textContent = 'é‹è¡Œä¸­'; document.getElementById('backup-status-badge').className = 'text-xs font-bold px-2 py-1 rounded bg-green-500 text-white'; } }

async function runBackup() { if(!backupFolderHandle) return; const allDir = await backupFolderHandle.getDirectoryHandle('all', { create: true }); const approvedDir = await backupFolderHandle.getDirectoryHandle('approved', { create: true }); for(const [key, photo] of submissions) { if(!backedUpPhotos.has(key)) { try { const filename = `${photo.uploader}_${photo.cat}_${key.substring(0,8)}.jpg`; await savePhotoToFolder(allDir, filename, photo.url); backedUpPhotos.add(key); } catch(e) {} } if((photo.status === 'approved' || photo.isWinner) && !backedUpApproved.has(key)) { try { const prefix = photo.isWinner ? 'ğŸ†' : 'â­'; const filename = `${prefix}${photo.uploader}_${photo.cat}_${key.substring(0,8)}.jpg`; await savePhotoToFolder(approvedDir, filename, photo.url); backedUpApproved.add(key); } catch(e) {} } } document.getElementById('backup-count').textContent = `${backedUpPhotos.size} å¼µ`; document.getElementById('backup-approved-count').textContent = `${backedUpApproved.size} å¼µ`; }
async function savePhotoToFolder(dirHandle, filename, dataUrl) { const base64Data = dataUrl.split(',')[1]; if(!base64Data) return; const binaryString = atob(base64Data); const bytes = new Uint8Array(binaryString.length); for(let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i); const fileHandle = await dirHandle.getFileHandle(filename, { create: true }); const writable = await fileHandle.createWritable(); await writable.write(bytes); await writable.close(); }
async function downloadAllPhotos() { const photos = Array.from(submissions.values()); if(photos.length === 0) { alert('ç›®å‰æ²’æœ‰ç…§ç‰‡'); return; } const zip = new JSZip(); for(const p of photos) { const d = p.url.split(',')[1]; if(d) zip.file(`${p.uploader}_${p.cat}_${(p.odialog||'').substring(0,8)}.jpg`, d, {base64: true}); } const content = await zip.generateAsync({type: 'blob'}); const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = `wedding_all_${new Date().toISOString().slice(0,10)}.zip`; a.click(); }
async function downloadApprovedPhotos() { const photos = Array.from(submissions.values()).filter(p => p.status === 'approved' || p.isWinner); if(photos.length === 0) { alert('ç›®å‰æ²’æœ‰å…¥åœç…§ç‰‡'); return; } const zip = new JSZip(); for(const p of photos) { const d = p.url.split(',')[1]; if(d) zip.file(`${p.isWinner?'ğŸ†':''}${p.uploader}_${p.cat}.jpg`, d, {base64: true}); } const content = await zip.generateAsync({type: 'blob'}); const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = `wedding_approved_${new Date().toISOString().slice(0,10)}.zip`; a.click(); }
</script>
</body>
</html>
